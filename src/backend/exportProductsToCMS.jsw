import { products } from 'wix-stores-backend';
import wixData from 'wix-data';

export async function exportProductsToCMS() {
  try {
    console.log("üöÄ –ù–∞—á–∞–ª–æ —ç–∫—Å–ø–æ—Ä—Ç–∞");

    let allProducts = [];
    let skip = 0;
    let hasMore = true;

    // —Ü–∏–∫–ª –≤—ã–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Wix Stores
    while (hasMore) {
      const result = await products.queryProducts()
        .limit(50)
        .skip(skip)
        .find();

      console.log("‚û°Ô∏è –ü–æ–ª—É—á–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:", result.items.length);

      allProducts = allProducts.concat(result.items);
      hasMore = result.hasNext();
      skip += 50;
    }

    console.log("‚úÖ –¶–∏–∫–ª –∑–∞–≤–µ—Ä—à—ë–Ω, –≤—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤:", allProducts.length);

    // —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ–¥ –∫–æ–ª–ª–µ–∫—Ü–∏—é ExportProducts
    const formatted = allProducts.map(p => ({
      name_ro: p.name || "",
      slug: p.slug || "",
      sku: p.sku || "",
      price: p.price?.price || 0,
      discountedPrice: p.price?.discountedPrice || "",
      currency: p.price?.currency || "",
      description_ro: p.description || "",
      seoTitle_ro: p.seo?.title || "",
      seoDescription_ro: p.seo?.description || "",
      seoKeywords_ro: (p.seo?.keywords || []).join(", "),
      mainImage: p.mainMedia?.src || "",
      lastUpdated: new Date()
    }));

    console.log("üõ† –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:", formatted.length);

    // –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ CMS –∫–æ–ª–ª–µ–∫—Ü–∏—é ExportProducts
    for (let item of formatted) {
      await wixData.insert("ExportProducts", item);
    }

    console.log("‚úÖ –í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤—Å—Ç–∞–≤–ª–µ–Ω—ã");
    return { success: true, count: formatted.length };

  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:", err);
    return { success: false, error: err.message };
  }
}